@page "/"
@inject HttpClient Http
@inject IAuthService AuthService
@inject NavigationManager Navigation

<PageTitle>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</PageTitle>

<div class="dashboard-container">
    <h2>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§</h2>

    @if (isLoading)
    {
        <Loading Message="Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¢Ù…Ø§Ø±..." />
    }
    else if (stats != null)
    {
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon events">ğŸ“‹</div>
                <div class="stat-info">
                    <h3>@stats.TotalEvents</h3>
                    <p>Ú©Ù„ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon tasks">âœ…</div>
                <div class="stat-info">
                    <h3>@stats.TotalTasks</h3>
                    <p>Ú©Ù„ ÙˆØ¸Ø§ÛŒÙ</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon users">ğŸ‘¥</div>
                <div class="stat-info">
                    <h3>@stats.TotalUsers</h3>
                    <p>Ú©Ù„ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon progress">ğŸ“Š</div>
                <div class="stat-info">
                    <h3>@stats.AverageProgress.ToString("F1")%</h3>
                    <p>Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ù¾ÛŒØ´Ø±ÙØª</p>
                </div>
            </div>
        </div>

        <div class="dashboard-row">
            <div class="dashboard-col">
                <div class="card">
                    <h3>Ø¢Ø®Ø±ÛŒÙ† Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§</h3>
                    @if (stats.RecentEvents.Any())
                    {
                        <div class="events-list">
                            @foreach (var ev in stats.RecentEvents)
                            {
                                <div class="event-item">
                                    <div class="event-title">@ev.Title</div>
                                    <div class="event-date">@ev.CreatedAt.ToString("yyyy/MM/dd")</div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <p class="no-data">Ø±ÙˆÛŒØ¯Ø§Ø¯ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</p>
                    }
                </div>
            </div>

            <div class="dashboard-col">
                <div class="card">
                    <h3>ÙØ¹Ø§Ù„ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</h3>
                    @if (activityLogs.Any())
                    {
                        <div class="activity-list">
                            @foreach (var log in activityLogs.Take(10))
                            {
                                <div class="activity-item">
                                    <span class="activity-type">@log.ActivityType</span>
                                    <span class="activity-desc">@log.Description</span>
                                    <span class="activity-time">@log.ActivityDateTime.ToString("HH:mm")</span>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <p class="no-data">ÙØ¹Ø§Ù„ÛŒØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</p>
                    }
                </div>
            </div>
        </div>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <Alert Type="danger" Message="@errorMessage" />
    }
</div>

@code {
    private DashboardStatsDto? stats;
    private List<ActivityLogDto> activityLogs = new();
    private bool isLoading = true;
    private string errorMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardData();
    }

    private async Task LoadDashboardData()
    {
        isLoading = true;
        errorMessage = string.Empty;

        try
        {
            var token = await AuthService.GetTokenAsync();
            if (string.IsNullOrEmpty(token))
            {
                Navigation.NavigateTo("/login");
                return;
            }

            Http.DefaultRequestHeaders.Authorization = 
                new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);

            var statsResponse = await Http.GetFromJsonAsync<ApiResponse<DashboardStatsDto>>("api/Dashboard/stats");
            if (statsResponse?.IsSuccess == true)
            {
                stats = statsResponse.Data;
            }

            var logsResponse = await Http.GetFromJsonAsync<ApiResponse<List<ActivityLogDto>>>("api/Dashboard/activity-logs?pageSize=10");
            if (logsResponse?.IsSuccess == true && logsResponse.Data != null)
            {
                activityLogs = logsResponse.Data;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    // DTOs
    private class ApiResponse<T>
    {
        public bool IsSuccess { get; set; }
        public T? Data { get; set; }
    }

    private class DashboardStatsDto
    {
        public int TotalEvents { get; set; }
        public int TotalTasks { get; set; }
        public int TotalUsers { get; set; }
        public double AverageProgress { get; set; }
        public List<RecentEventDto> RecentEvents { get; set; } = new();
    }

    private class RecentEventDto
    {
        public int Id { get; set; }
        public string Title { get; set; } = string.Empty;
        public DateTime CreatedAt { get; set; }
    }

    private class ActivityLogDto
    {
        public string ActivityType { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public DateTime ActivityDateTime { get; set; }
    }
}

<style>
    .dashboard-container {
        padding: 20px;
        direction: rtl;
    }

    h2 {
        color: #333;
        margin-bottom: 30px;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .stat-icon {
        width: 60px;
        height: 60px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 30px;
    }

    .stat-icon.events { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .stat-icon.tasks { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .stat-icon.users { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .stat-icon.progress { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }

    .stat-info h3 {
        margin: 0;
        font-size: 32px;
        color: #333;
    }

    .stat-info p {
        margin: 5px 0 0 0;
        color: #666;
    }

    .dashboard-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 20px;
    }

    .card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .card h3 {
        margin-top: 0;
        color: #333;
        border-bottom: 2px solid #667eea;
        padding-bottom: 10px;
    }

    .events-list, .activity-list {
        margin-top: 15px;
    }

    .event-item {
        padding: 12px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
    }

    .event-title {
        font-weight: 500;
        color: #333;
    }

    .event-date {
        color: #999;
        font-size: 14px;
    }

    .activity-item {
        padding: 10px;
        border-bottom: 1px solid #eee;
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .activity-type {
        background: #667eea;
        color: white;
        padding: 4px 10px;
        border-radius: 5px;
        font-size: 12px;
    }

    .activity-desc {
        flex: 1;
        color: #666;
    }

    .activity-time {
        color: #999;
        font-size: 12px;
    }

    .no-data {
        text-align: center;
        color: #999;
        padding: 20px;
    }
</style>
