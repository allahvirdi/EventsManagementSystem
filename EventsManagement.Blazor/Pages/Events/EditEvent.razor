@page "/events/edit/{Id:int}"
@inject HttpClient Http
@inject IAuthService AuthService
@inject NavigationManager Navigation

<PageTitle>ویرایش رویداد</PageTitle>

<div class="page-container">
    <div class="page-header">
        <h2>ویرایش رویداد</h2>
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <Alert Type="danger" Message="@errorMessage" OnClose="() => errorMessage = string.Empty" />
    }

    @if (isLoading)
    {
        <Loading />
    }
    else if (model != null)
    {
        <div class="form-card">
            <EditForm Model="@model" OnValidSubmit="HandleSubmit">
                <DataAnnotationsValidator />

                <!-- بخش ۱: اطلاعات اولیه -->
                <div class="section-header">اطلاعات اولیه</div>
                
                <div class="form-group">
                    <label>عنوان رویداد *</label>
                    <InputText @bind-Value="model.Title" class="form-control" placeholder="عنوان رویداد را وارد کنید" />
                    <ValidationMessage For="@(() => model.Title)" />
                </div>

                <div class="form-group">
                    <label>توضیحات</label>
                    <InputTextArea @bind-Value="model.Description" class="form-control" rows="4" placeholder="توضیحات رویداد را وارد کنید" />
                </div>

                <!-- بخش ۲: طبقه‌بندی رویداد -->
                <div class="section-header">طبقه‌بندی رویداد</div>

                <DynamicDropdown 
                    TableName="EventSource"
                    Title="منبع رویداد *"
                    Placeholder="منبع رویداد را انتخاب کنید"
                    Value="@eventSourceId"
                    ValueChanged="@((int? val) => { eventSourceId = val; model.EventSourceId = val ?? 0; })"
                    AllowAdd="true" />

                <DynamicDropdown 
                    TableName="EventSubject"
                    Title="موضوع رویداد *"
                    Placeholder="موضوع رویداد را انتخاب کنید"
                    Value="@eventSubjectId"
                    ValueChanged="@((int? val) => { eventSubjectId = val; model.EventSubjectId = val ?? 0; })"
                    AllowAdd="true" />

                <DynamicDropdown 
                    TableName="Urgency"
                    Title="فوریت *"
                    Placeholder="میزان فوریت را انتخاب کنید"
                    Value="@urgencyId"
                    ValueChanged="@((int? val) => { urgencyId = val; model.UrgencyId = val ?? 0; })"
                    AllowAdd="true" />

                <!-- بخش ۳: محدوده وقوع -->
                <div class="section-header">محدوده وقوع</div>

                <DynamicDropdown 
                    TableName="ScopeType"
                    Title="نوع محدوده *"
                    Placeholder="نوع محدوده را انتخاب کنید"
                    Value="@scopeId"
                    ValueChanged="@((int? val) => { scopeId = val; model.ScopeId = val ?? 0; })"
                    AllowAdd="true" />

                <CascadingLocationSelector 
                    @bind-ProvinceId="scopeProvinceId"
                    @bind-RegionId="scopeRegionId"
                    @bind-SchoolId="scopeSchoolId"
                    ShowSchool="true"
                    AllowAddProvince="true"
                    AllowAddRegion="true"
                    AllowAddSchool="true" />

                <!-- بخش ۴: محدوده تأثیر -->
                <div class="section-header">محدوده تأثیر</div>

                <DynamicDropdown 
                    TableName="ImpactScopeType"
                    Title="نوع محدوده تأثیر *"
                    Placeholder="نوع محدوده تأثیر را انتخاب کنید"
                    Value="@impactScopeId"
                    ValueChanged="@((int? val) => { impactScopeId = val; model.ImpactScopeId = val ?? 0; })"
                    AllowAdd="true" />

                <CascadingLocationSelector 
                    @bind-ProvinceId="impactProvinceId"
                    @bind-RegionId="impactRegionId"
                    @bind-SchoolId="impactSchoolId"
                    ShowSchool="true"
                    AllowAddProvince="true"
                    AllowAddRegion="true"
                    AllowAddSchool="true" />

                <!-- بخش ۵: دامنه تأثیر -->
                <div class="section-header">دامنه تأثیر</div>

                <DynamicDropdown 
                    TableName="ImpactRange"
                    Title="دامنه تأثیر (درون/برون دستگاهی) *"
                    Placeholder="دامنه تأثیر را انتخاب کنید"
                    Value="@impactRangeId"
                    ValueChanged="@((int? val) => { impactRangeId = val; model.ImpactRangeId = val ?? 0; })"
                    AllowAdd="true" />

                <!-- بخش ۶: بازه زمانی -->
                <div class="section-header">بازه زمانی</div>

                <div class="form-row">
                    <div class="form-group">
                        <label>تاریخ شروع *</label>
                        <PersianDatePicker Value="@startDate" ValueChanged="@((DateTime? val) => { startDate = val; model.StartDate = val ?? DateTime.Now; })" />
                        <ValidationMessage For="@(() => model.StartDate)" />
                    </div>

                    <div class="form-group">
                        <label>تاریخ پایان *</label>
                        <PersianDatePicker Value="@endDate" ValueChanged="@((DateTime? val) => { endDate = val; model.EndDate = val ?? DateTime.Now; })" />
                        <ValidationMessage For="@(() => model.EndDate)" />
                    </div>
                </div>

                <!-- بخش ۷: واحد اقدام کننده -->
                <div class="section-header">واحد اقدام کننده</div>

                <div class="form-group">
                    <label>واحد مسئول *</label>
                    <select @bind="model.ResponsibleUnitId" class="form-control">
                        <option value="0">واحد سازمانی را انتخاب کنید</option>
                        @foreach (var unit in organizationUnits)
                        {
                            <option value="@unit.Id">@unit.Name</option>
                        }
                    </select>
                    <ValidationMessage For="@(() => model.ResponsibleUnitId)" />
                </div>

                <!-- بخش ۸: مستندات -->
                <div class="section-header">مستندات</div>

                <FileUploader 
                    EntityId="@Id"
                    EntityType="Event"
                    @bind-UploadedFiles="uploadedFiles" />

                <!-- بخش ۹: رویدادهای مرتبط -->
                <div class="section-header">رویدادهای مرتبط</div>

                <RelatedEventsSelector 
                    ExcludeEventId="@Id"
                    @bind-SelectedEventIds="relatedEventIds" />

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">ذخیره تغییرات</button>
                    <button type="button" class="btn btn-secondary" @onclick='() => Navigation.NavigateTo("/events")'>انصراف</button>
                </div>
            </EditForm>
        </div>
    }
</div>

@code {
    [Parameter]
    public int Id { get; set; }

    private UpdateEventModel? model;
    private bool isLoading = false;
    private string errorMessage = string.Empty;

    // DynamicDropdown values
    private int? eventSourceId;
    private int? eventSubjectId;
    private int? urgencyId;
    private int? scopeId;
    private int? impactScopeId;
    private int? impactRangeId;

    // Date values
    private DateTime? startDate;
    private DateTime? endDate;

    // محدوده وقوع
    private int? scopeProvinceId;
    private int? scopeRegionId;
    private int? scopeSchoolId;

    // محدوده تأثیر
    private int? impactProvinceId;
    private int? impactRegionId;
    private int? impactSchoolId;

    // فایل‌ها و رویدادهای مرتبط
    private List<FileUploader.UploadedFile> uploadedFiles = new();
    private List<int> relatedEventIds = new();

    // لیست واحدهای سازمانی
    private List<OrganizationUnitItem> organizationUnits = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadOrganizationUnits();
        await LoadEvent();
    }

    private async Task LoadOrganizationUnits()
    {
        try
        {
            var token = await AuthService.GetTokenAsync();
            if (string.IsNullOrEmpty(token)) return;

            Http.DefaultRequestHeaders.Authorization = 
                new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);

            var response = await Http.GetAsync("api/OrganizationUnits?pageSize=1000");
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<PagedResult<OrganizationUnitItem>>();
                if (result != null)
                {
                    organizationUnits = result.Items;
                }
            }
        }
        catch { }
    }

    private async Task LoadEvent()
    {
        isLoading = true;
        errorMessage = string.Empty;

        try
        {
            var token = await AuthService.GetTokenAsync();
            if (string.IsNullOrEmpty(token))
            {
                Navigation.NavigateTo("/login");
                return;
            }

            Http.DefaultRequestHeaders.Authorization = 
                new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);

            var response = await Http.GetFromJsonAsync<EventDto>($"api/Events/{Id}");

            if (response != null)
            {
                model = new UpdateEventModel
                {
                    Title = response.Title,
                    Description = response.Description,
                    EventSourceId = response.EventSourceId,
                    EventSubjectId = response.EventSubjectId,
                    UrgencyId = response.UrgencyId,
                    ScopeId = response.ScopeId,
                    ImpactScopeId = response.ImpactScopeId,
                    ImpactRangeId = response.ImpactRangeId,
                    StartDate = response.StartDate,
                    EndDate = response.EndDate,
                    ResponsibleUnitId = response.ResponsibleUnitId
                };

                // Populate intermediate fields
                eventSourceId = response.EventSourceId;
                eventSubjectId = response.EventSubjectId;
                urgencyId = response.UrgencyId;
                scopeId = response.ScopeId;
                impactScopeId = response.ImpactScopeId;
                impactRangeId = response.ImpactRangeId;
                startDate = response.StartDate;
                endDate = response.EndDate;

                // Parse location data from JSON
                if (!string.IsNullOrEmpty(response.ScopeDetails))
                {
                    try
                    {
                        var scopeData = System.Text.Json.JsonSerializer.Deserialize<LocationDetails>(response.ScopeDetails);
                        if (scopeData != null)
                        {
                            scopeProvinceId = scopeData.ProvinceId;
                            scopeRegionId = scopeData.RegionId;
                            scopeSchoolId = scopeData.SchoolId;
                        }
                    }
                    catch { }
                }

                if (!string.IsNullOrEmpty(response.ImpactScopeDetails))
                {
                    try
                    {
                        var impactData = System.Text.Json.JsonSerializer.Deserialize<LocationDetails>(response.ImpactScopeDetails);
                        if (impactData != null)
                        {
                            impactProvinceId = impactData.ProvinceId;
                            impactRegionId = impactData.RegionId;
                            impactSchoolId = impactData.SchoolId;
                        }
                    }
                    catch { }
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"خطا در بارگذاری رویداد: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task HandleSubmit()
    {
        isLoading = true;
        errorMessage = string.Empty;

        try
        {
            var token = await AuthService.GetTokenAsync();
            if (string.IsNullOrEmpty(token))
            {
                Navigation.NavigateTo("/login");
                return;
            }

            Http.DefaultRequestHeaders.Authorization = 
                new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);

            // تبدیل اطلاعات مکان به JSON
            model!.ScopeDetails = System.Text.Json.JsonSerializer.Serialize(new
            {
                ProvinceId = scopeProvinceId,
                RegionId = scopeRegionId,
                SchoolId = scopeSchoolId
            });

            model.ImpactScopeDetails = System.Text.Json.JsonSerializer.Serialize(new
            {
                ProvinceId = impactProvinceId,
                RegionId = impactRegionId,
                SchoolId = impactSchoolId
            });

            var response = await Http.PutAsJsonAsync($"api/Events/{Id}", model);

            if (response.IsSuccessStatusCode)
            {
                Navigation.NavigateTo("/events");
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                errorMessage = $"خطا در ویرایش رویداد: {error}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"خطا: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private class UpdateEventModel
    {
        [Required(ErrorMessage = "عنوان الزامی است")]
        public string Title { get; set; } = string.Empty;

        public string? Description { get; set; }

        [Required(ErrorMessage = "منبع رویداد الزامی است")]
        [Range(1, int.MaxValue, ErrorMessage = "منبع رویداد را انتخاب کنید")]
        public int EventSourceId { get; set; }

        [Required(ErrorMessage = "موضوع رویداد الزامی است")]
        [Range(1, int.MaxValue, ErrorMessage = "موضوع رویداد را انتخاب کنید")]
        public int EventSubjectId { get; set; }

        [Required(ErrorMessage = "فوریت الزامی است")]
        [Range(1, int.MaxValue, ErrorMessage = "فوریت را انتخاب کنید")]
        public int UrgencyId { get; set; }

        [Required(ErrorMessage = "محدوده وقوع الزامی است")]
        [Range(1, int.MaxValue, ErrorMessage = "محدوده وقوع را انتخاب کنید")]
        public int ScopeId { get; set; }

        public string? ScopeDetails { get; set; }

        [Required(ErrorMessage = "محدوده تأثیر الزامی است")]
        [Range(1, int.MaxValue, ErrorMessage = "محدوده تأثیر را انتخاب کنید")]
        public int ImpactScopeId { get; set; }

        public string? ImpactScopeDetails { get; set; }

        [Required(ErrorMessage = "دامنه تأثیر الزامی است")]
        [Range(1, int.MaxValue, ErrorMessage = "دامنه تأثیر را انتخاب کنید")]
        public int ImpactRangeId { get; set; }

        [Required(ErrorMessage = "تاریخ شروع الزامی است")]
        public DateTime StartDate { get; set; }

        [Required(ErrorMessage = "تاریخ پایان الزامی است")]
        public DateTime EndDate { get; set; }

        [Required(ErrorMessage = "واحد مسئول الزامی است")]
        [Range(1, int.MaxValue, ErrorMessage = "واحد مسئول را انتخاب کنید")]
        public int ResponsibleUnitId { get; set; }
    }

    private class EventDto
    {
        public int Id { get; set; }
        public string Title { get; set; } = string.Empty;
        public string? Description { get; set; }
        public int EventSourceId { get; set; }
        public int EventSubjectId { get; set; }
        public int UrgencyId { get; set; }
        public int ScopeId { get; set; }
        public string? ScopeDetails { get; set; }
        public int ImpactScopeId { get; set; }
        public string? ImpactScopeDetails { get; set; }
        public int ImpactRangeId { get; set; }
        public DateTime StartDate { get; set; }
        public DateTime EndDate { get; set; }
        public int ResponsibleUnitId { get; set; }
    }

    private class LocationDetails
    {
        public int? ProvinceId { get; set; }
        public int? RegionId { get; set; }
        public int? SchoolId { get; set; }
    }

    private class OrganizationUnitItem
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
    }

    private class PagedResult<T>
    {
        public List<T> Items { get; set; } = new();
        public int TotalCount { get; set; }
    }
}

<style>
    .page-container {
        padding: 20px;
        direction: rtl;
        max-width: 800px;
        margin: 0 auto;
    }

    .page-header {
        margin-bottom: 30px;
    }

    .page-header h2 {
        color: #333;
        font-weight: 700;
    }

    .form-card {
        background: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        color: #555;
        font-weight: 600;
    }

    .form-control {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.3s;
    }

    .form-control:focus {
        outline: none;
        border-color: #667eea;
    }

    .validation-message {
        color: #dc3545;
        font-size: 12px;
        margin-top: 5px;
    }

    .section-header {
        font-size: 18px;
        font-weight: 700;
        color: #667eea;
        margin: 30px 0 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e0e0e0;
    }

    .form-actions {
        display: flex;
        gap: 15px;
        margin-top: 30px;
    }

    .btn {
        padding: 12px 30px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        flex: 1;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }
</style>
