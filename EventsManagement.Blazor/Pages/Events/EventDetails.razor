@page "/events/{Id:int}"
@inject HttpClient Http
@inject IAuthService AuthService
@inject NavigationManager Navigation

<PageTitle>Ø¬Ø²Ø¦ÛŒØ§Øª Ø±ÙˆÛŒØ¯Ø§Ø¯</PageTitle>

<div class="page-container">
    @if (isLoading)
    {
        <Loading />
    }
    else if (eventDetails != null)
    {
        <div class="event-header">
            <h2>@eventDetails.Title</h2>
            <button class="btn btn-secondary" @onclick='() => Navigation.NavigateTo("/events")'>Ø¨Ø§Ø²Ú¯Ø´Øª</button>
        </div>

        <div class="details-grid">
            <div class="card">
                <h3>Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø±ÙˆÛŒØ¯Ø§Ø¯</h3>
                <div class="info-item">
                    <strong>ØªÙˆØ¶ÛŒØ­Ø§Øª:</strong>
                    <p>@eventDetails.Description</p>
                </div>
                <div class="info-row">
                    <div class="info-item">
                        <strong>ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹:</strong>
                        <span>@eventDetails.StartDate.ToPersianDate()</span>
                    </div>
                    <div class="info-item">
                        <strong>ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù†:</strong>
                        <span>@eventDetails.EndDate.ToPersianDate()</span>
                    </div>
                </div>
                <div class="info-row">
                    <div class="info-item">
                        <strong>ÙˆØ¶Ø¹ÛŒØª:</strong>
                        <span class="badge">@eventDetails.StatusId</span>
                    </div>
                    <div class="info-item">
                        <strong>Ø´Ø¯Øª:</strong>
                        <span class="badge badge-warning">@eventDetails.SeverityId</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>ÙˆØ¸Ø§ÛŒÙ (@tasks.Count)</h3>
                    <button class="btn btn-sm btn-primary" @onclick='() => Navigation.NavigateTo($"/events/{Id}/tasks/create")'>
                        Ø§ÙØ²ÙˆØ¯Ù† ÙˆØ¸ÛŒÙÙ‡
                    </button>
                </div>
                @if (tasks.Any())
                {
                    <div class="tasks-list">
                        @foreach (var task in tasks)
                        {
                            <div class="task-item">
                                <div>
                                    <strong>@task.Title</strong>
                                    <p>@task.Description</p>
                                </div>
                                <span class="badge">@task.StatusId</span>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <p class="no-data">Ù‡ÛŒÚ† ÙˆØ¸ÛŒÙÙ‡â€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</p>
                }
            </div>

            <div class="card">
                <h3>ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ (@files.Count)</h3>
                @if (files.Any())
                {
                    <div class="files-list">
                        @foreach (var file in files)
                        {
                            <div class="file-item">
                                <span>ğŸ“„ @file.FileName</span>
                                <small>@file.FileSize KB</small>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <p class="no-data">Ù‡ÛŒÚ† ÙØ§ÛŒÙ„ÛŒ Ø¢Ù¾Ù„ÙˆØ¯ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</p>
                }
            </div>

            <div class="card">
                <h3>Ù†Ø¸Ø±Ø§Øª (@comments.Count)</h3>
                @if (comments.Any())
                {
                    <div class="comments-list">
                        @foreach (var comment in comments)
                        {
                            <div class="comment-item">
                                <div class="comment-header">
                                    <strong>@comment.CreatedByName</strong>
                                    <small>@comment.CreatedAt.ToPersianDateTime()</small>
                                </div>
                                <p>@comment.Text</p>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <p class="no-data">Ù‡ÛŒÚ† Ù†Ø¸Ø±ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</p>
                }
            </div>
        </div>
    }
    else
    {
        <div class="no-data">Ø±ÙˆÛŒØ¯Ø§Ø¯ ÛŒØ§ÙØª Ù†Ø´Ø¯</div>
    }
</div>

@code {
    [Parameter]
    public int Id { get; set; }

    private EventDetailsDto? eventDetails;
    private List<TaskDto> tasks = new();
    private List<FileDto> files = new();
    private List<CommentDto> comments = new();
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadEventDetails();
    }

    private async Task LoadEventDetails()
    {
        isLoading = true;

        try
        {
            var token = await AuthService.GetTokenAsync();
            if (string.IsNullOrEmpty(token))
            {
                Navigation.NavigateTo("/login");
                return;
            }

            Http.DefaultRequestHeaders.Authorization = 
                new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);

            var eventResponse = await Http.GetFromJsonAsync<ApiResponse<EventDetailsDto>>($"api/Events/{Id}");
            if (eventResponse?.IsSuccess == true)
            {
                eventDetails = eventResponse.Data;
            }

            var tasksResponse = await Http.GetFromJsonAsync<ApiResponse<List<TaskDto>>>($"api/Tasks?eventId={Id}");
            if (tasksResponse?.IsSuccess == true)
            {
                tasks = tasksResponse.Data ?? new();
            }

            var filesResponse = await Http.GetFromJsonAsync<ApiResponse<List<FileDto>>>($"api/Files?relatedEntityType=Event&relatedEntityId={Id}");
            if (filesResponse?.IsSuccess == true)
            {
                files = filesResponse.Data ?? new();
            }

            var commentsResponse = await Http.GetFromJsonAsync<ApiResponse<List<CommentDto>>>($"api/Comments?relatedEntityType=Event&relatedEntityId={Id}");
            if (commentsResponse?.IsSuccess == true)
            {
                comments = commentsResponse.Data ?? new();
            }
        }
        catch (Exception)
        {
            // Handle error
        }
        finally
        {
            isLoading = false;
        }
    }

    private class ApiResponse<T>
    {
        public bool IsSuccess { get; set; }
        public T? Data { get; set; }
    }

    private class EventDetailsDto
    {
        public int Id { get; set; }
        public string Title { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public DateTime StartDate { get; set; }
        public DateTime EndDate { get; set; }
        public int StatusId { get; set; }
        public int SeverityId { get; set; }
    }

    private class TaskDto
    {
        public int Id { get; set; }
        public string Title { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public int StatusId { get; set; }
    }

    private class FileDto
    {
        public int Id { get; set; }
        public string FileName { get; set; } = string.Empty;
        public long FileSize { get; set; }
    }

    private class CommentDto
    {
        public int Id { get; set; }
        public string Text { get; set; } = string.Empty;
        public string CreatedByName { get; set; } = string.Empty;
        public DateTime CreatedAt { get; set; }
    }
}

<style>
    .page-container {
        padding: 20px;
        direction: rtl;
    }

    .event-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
    }

    .event-header h2 {
        color: #333;
        font-weight: 700;
    }

    .details-grid {
        display: grid;
        gap: 20px;
    }

    .card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .card h3 {
        margin-bottom: 15px;
        color: #667eea;
        font-size: 18px;
    }

    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .info-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 15px;
    }

    .info-item {
        margin-bottom: 10px;
    }

    .info-item strong {
        display: block;
        color: #666;
        margin-bottom: 5px;
        font-size: 14px;
    }

    .info-item span, .info-item p {
        color: #333;
    }

    .badge {
        padding: 4px 10px;
        border-radius: 5px;
        background: #667eea;
        color: white;
        font-size: 12px;
    }

    .badge-warning {
        background: #f39c12;
    }

    .tasks-list, .files-list, .comments-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .task-item, .file-item, .comment-item {
        padding: 12px;
        background: #f8f9fa;
        border-radius: 8px;
        border-right: 4px solid #667eea;
    }

    .task-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .task-item p {
        margin: 5px 0 0 0;
        font-size: 13px;
        color: #666;
    }

    .comment-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
    }

    .comment-header small {
        color: #999;
    }

    .file-item {
        display: flex;
        justify-content: space-between;
    }

    .no-data {
        text-align: center;
        color: #999;
        padding: 20px;
    }

    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

    .btn-sm {
        padding: 6px 12px;
        font-size: 12px;
    }
</style>
